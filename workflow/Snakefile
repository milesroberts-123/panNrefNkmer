# load packages

import pandas as pd
import os
from snakemake.utils import validate
from snakemake.utils import min_version

min_version("9.3.3")

# configuration
configfile: "../config/config.yaml"


#validate(config, "../config/config.schema.yaml")


# container version of workflow
#containerized: "docker://milesroberts/poolseq-kmers"


# load samples
#parameters = pd.read_table(
#    "../config/parameters.tsv", sep="\t", dtype={"ID": str}
#).set_index(["ID"], drop=False)

#validate(parameters, "../config/parameters.schema.yaml")

rule all:
    input:
        expand("{ID}_{linref}_{panref}.done", ID = config["samples"], linref = config["linrefs"], panref = config["panrefs"]),

rule all_per_id:
    input:
        "kmc_results/kmer_counts_{ID}.txt",
        "bwa_results/{ID}_{linref}.bam",
        "vg_surject_results/{ID}_{panref}_{linref}.bam"
    output:
        touch("{ID}_{linref}_{panref}.done")

include: "rules/datasets.smk"
include: "rules/sra.smk"
include: "rules/fastp.smk"
include: "rules/bwa_index.smk"
include: "rules/bwa_mem.smk"
include: "rules/datasets.smk"
include: "rules/kmc_contam_db.smk"
include: "rules/kmc_rm_contam.smk"
include: "rules/kmc.smk"
include: "rules/vg_index.smk"
include: "rules/vg_giraffe.smk"
include: "rules/vg_filter.smk"
include: "rules/vg_surject.smk"
