# load packages

import pandas as pd
import os
from snakemake.utils import validate
from snakemake.utils import min_version

min_version("9.5.1")

# configuration
configfile: "../config/config.yaml"

#validate(config, "../config/config.schema.yaml")


# container version of workflow
#containerized: "docker://milesroberts/poolseq-kmers"


# load samples
#parameters = pd.read_table(
#    "../config/parameters.tsv", sep="\t", dtype={"ID": str}
#).set_index(["ID"], drop=False)

#validate(parameters, "../config/parameters.schema.yaml")

rule all:
    input:
        expand("{ID}_{linref}_{panref}.done", ID = config["samples"], linref = config["linrefs"], panref = config["panrefs"]),
        "kmer_distances.txt",
        "multiqc_report.html"

rule all_per_id:
    input:
        "cbf_results/{ID}.txt",
        #"bcftools_panref_results/{ID}_{panref}_{linref}.vcf",
        "mk_test_{linref}/mk.tsv",
        "salmon_quantmerge_results/{linref}.txt",
        "bcftools_concat_results/{linref}.vcf.gz",
        expand("pixy_results/{{linref}}_{stat}.txt",stat = ["pi", "watterson_theta", "tajima_d", "dxy", "fst"])
    output:
        touch("{ID}_{linref}_{panref}.done")

## data download and QC rules
include: "rules/datasets.smk"
include: "rules/sra.smk"
include: "rules/fastp.smk"
include: "rules/multiqc.smk"

## linear alignment rules
include: "rules/bwa_index.smk"
include: "rules/bwa_mem.smk"
include: "rules/mark_dup.smk"

## genotype calling rules
include: "rules/bcftools_call.smk"
include: "rules/bcftools_merge.smk"

## k-mer counting rules
include: "rules/datasets.smk"
include: "rules/kmc_contam_db.smk"
include: "rules/kmc_rm_contam.smk"
include: "rules/kmc.smk"
include: "rules/counting_bloom_filter.smk"
include: "rules/cbind.smk"
include: "rules/kmer_distances.smk"

## pangenome alignment rules
include: "rules/vg_index.smk"
include: "rules/vg_giraffe.smk"
include: "rules/vg_filter.smk"
include: "rules/vg_surject.smk"
include: "rules/vg_paths.smk"

## gene expression quantification
include: "rules/salmon_index.smk"
include: "rules/salmon_quantmerge.smk"
include: "rules/salmon_quant.smk"

## population genetics summary rules
include: "rules/mk_test.smk"
include: "rules/degenotate.smk"
include: "rules/split_sites.smk"
include: "rules/pixy.smk"
